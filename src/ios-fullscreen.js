var BASE_URL = 'https://nolimitjs.nolimitcdn.com/img';
var FINGER = BASE_URL + '/finger.svg';
var ARROW = BASE_URL + '/arrow.svg';

var fullscreen = false;

function preventResize(e) {
    if(e.scale !== 1) {
        e.preventDefault();
        e.stopPropagation();
    }
}

function getOrientation() {
    return window.innerHeight > window.innerWidth ? 'portrait' : 'landscape';
}

function addCss(document) {
    var style = document.createElement('style');
    document.head.appendChild(style);
    style.appendChild(document.createTextNode(require('./ios-fullscreen.css')));
}

var iosFullscreen = {
    init: function(options, document) {
        var ua = navigator.userAgent.toLowerCase();
        var isSafari = ua.indexOf('safari') !== -1 && ua.indexOf('chrome') === -1;
        var iFramed = window.top !== window.self;

        if(!isSafari || iFramed || options.device !== 'mobile') {
            return;
        }

        addCss(document);

        // The element that prevents swipes later
        var swipeBlocker = document.createElement('div');
        swipeBlocker.id = 'nolimit-swipe-blocker';

        // The Element containing the swipe up animation
        var swipeOverlay = document.createElement('div');
        swipeOverlay.id = 'nolimit-swipe-overlay';

        var finger = document.createElement('img');
        finger.id = 'nolimit-swipe-finger';
        finger.src = FINGER;
        swipeOverlay.appendChild(finger);

        var arrow = document.createElement('img');
        arrow.id = 'nolimit-swipe-arrow';
        arrow.src = ARROW;
        swipeOverlay.appendChild(arrow);

        swipeBlocker.addEventListener('touchmove', preventResize);
        arrow.addEventListener('touchmove', preventResize);

        document.body.appendChild(swipeBlocker);
        document.body.appendChild(swipeOverlay);

        function enableOverlay() {
            window.focus();
            window.scrollTo(0, 0);
            swipeBlocker.style.visibility = 'visible';
            swipeBlocker.style.pointerEvents = 'auto';
        }

        function disableOverlay() {
            swipeOverlay.style.visibility = 'hidden';
            swipeBlocker.style.visibility = 'hidden';
            swipeBlocker.style.pointerEvents = 'none';
        }

        function onResize() {
            if(getOrientation() === 'landscape') {
                enableOverlay();
            } else {
                disableOverlay();
            }
        }

        function checkEndState() {
            if(window.innerHeight >= screen.width) {
                fullscreen = true;
                disableOverlay();
            } else {
                swipeOverlay.style.visibility = 'visible';

                if(fullscreen) {
                    enableOverlay();
                    fullscreen = false;
                }
            }
        }

        function checkScreenState() {
            if(getOrientation() === 'landscape') {
                checkEndState();
            } else {
                swipeOverlay.style.visibility = 'hidden';
            }
        }

        window.addEventListener('resize', onResize);
        window.setInterval(checkScreenState, 10);
        window.addEventListener('DOMContentLoaded', onResize);
    }
};

module.exports = iosFullscreen;
